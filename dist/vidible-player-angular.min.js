!function(e){"use strict";e.module("vidible-module",[]).service("VidibleQueueLoader",["$http","$timeout",function(i,n){function t(e,n,t,d){var l="http://delivery.vidible.tv/jsonp/pid="+n+"/vid="+e+"/"+t+".js";i.get(l).then(function(e){d(e.status,e.data)},function(e){d(e.status,null)})}function d(e,i,t){if(r||(r=(new Date).getTime()),e.vdb_Player)i(e.vdb_Player),r=null;else{var l=(new Date).getTime(),o=l-r;if(o>=t)return console.error("Timeout while waiting to vidible script to load..."),console.log(e),void(r=null);n(function(){d(e,i,t)},0)}}function l(){if(a.length>0){var i=a.shift(),n=angular.element('<div class="player vdb_player"></div>');t(i.vidOptions.videoId,i.vidOptions.vidiblePlayerId,i.vidOptions.vidibleAccountId,function(t,r){if(200===t){var u=e.element(n),a=document.createElement("script");u.addClass("vdb_"+i.vidOptions.vidiblePlayerId+i.vidOptions.vidibleAccountId),a.innerHTML='console.log("running vidible script");\n'+r,n[0].appendChild(a),i.elem.append(n),d(n[0],function(e){i.cb(e),l()},o)}else console.error("Error loading vidable with id = "+i.vid),l()})}}var r,o=3e4,u={},a=[];return r=null,u.queueForProcessing=function(e,i,n,t,d){a.push({vidOptions:{videoId:e,vidiblePlayerId:i,vidibleAccountId:n},elem:t,cb:d}),a.length>1||l()},u}]).directive("vidiblePlayer",["$window","$interval","VidibleQueueLoader",function(e,i,n){function t(i){switch(i){case e.vidible.PLAYER_READY:return d+"ready";case e.vidible.VIDEO_END:return d+"ended";case e.vidible.VIDEO_PAUSE:return d+"paused";case e.vidible.VIDEO_PLAY:return d+"playing";case e.vidible.VIDEO_DATA_LOADED:return d+"loaded";case e.vidible.VIDEO_TIMEUPDATE:return d+"timeUpdate"}}var d="vidible.player.",l="vidible.player.ready",r=1;return{restrict:"EA",scope:{videoId:"=videoId",player:"=?player",playerId:"@playerId",vidiblePlayerId:"@vidiblePlayerId",vidibleAccountId:"@vidibleAccountId"},link:function(e,o,u){function a(){var i=Array.prototype.slice.call(arguments);e.$emit.apply(e,i)}function c(e,i){[vidible.PLAYER_READY,vidible.VIDEO_DATA_LOADED,vidible.VIDEO_PLAY,vidible.VIDEO_PAUSE,vidible.VIDEO_END,vidible.VIDEO_TIMEUPDATE].forEach(function(n){i.addEventListener(n,function(d){a(t(n),e,i,d)})})}function v(){e.player&&e.player.getVidiblePlayer()&&e.player.getVidiblePlayer().destroy(),o.empty()}function s(e){var n,t=e.isMuted();return i(function(){var i=e.isMuted();void 0!==i&&(void 0!==t&&t!==i&&(n=d+(i?"muted":"unmuted"),a(n,e,{muted:i})),t=i)},100)}function y(n){var t={getVidiblePlayer:function(){return n},getVidibleElement:function(){return o[0].querySelector(".vdb_player")},pause:function(){n.pause()},play:function(){n.play()},replay:function(){n.seekTo(0),n.play()},mute:function(){n.mute()},unmute:function(){e.player.isMuted()&&n.mute()},getVolume:function(){try{return n.getPlayerInfo().volume}catch(e){return void 0}},setVolume:function(e){return n.volume(e)},isMuted:function(){var e=t.getVolume();return void 0===e||null===e?void 0:0===e},destroy:function(){console.warn("Player is not yet ready. nothing to destroy...")}};e.player=t,c(t,n),e.$on(l,function(e,n){if(n===t){var d=s(t);t.destroy=function(){i.cancel(d),v()}}})}function f(i){v(),n.queueForProcessing(i,e.vidiblePlayerId,e.vidibleAccountId,o,y)}var p,b=o[0].id||u.playerId||"page-unique-vidible-id-"+r++;o[0].id=b,p=e.$watch(function(){return"undefined"!=typeof e.videoId},function(i){i&&(p(),e.$watch("videoId",function(){f(e.videoId)}))}),e.$on("$destroy",function(){v()})}}}])}(angular);